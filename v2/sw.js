(()=>{"use strict";async function e(e,t,n){let a={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(t)};return n&&(a.headers=Object.assign(Object.assign({},a.headers),{Authorization:`Bearer ${n}`})),await fetch(e,a)}var t;!function(e){e.google="google",e.anonym="anonym"}(t||(t={}));class n{constructor(e){this.networkError=e}}class a{}class r{}let o;o="https://kontokorrent-v2.azurewebsites.net";const s="https://kontokorrent-v2.azurewebsites.net";class i{}const c=s;class u{constructor(e){this.accountInfoStore=e}async neuerBenutzer(t,n){try{return(await e(`${c}/api/v2/accounts`,{id:t,secret:n})).ok?{success:!0}:{success:!1}}catch(e){return{success:!1}}}async getUserInfo(){let e=await fetch(`${c}/api/v2/userinfo`,{headers:await this.getAuthHeader()});return await e.json()}async getAuthHeader(){return{Authorization:`Bearer ${await this.getAccessToken()}`}}async kontokorrentHinzufuegen(e,t){let n="";n=e?`oeffentlicherName=${encodeURIComponent(e)}`:`einladungsCode=${encodeURIComponent(t)}`;let a=await this.getAuthHeader(),r=await fetch(`${c}/api/v2/kontokorrents?${n}`,{method:"PUT",headers:a});return 404==r.status?null:await r.json()}async kontokorrentsAuflisten(){let e=await fetch(`${c}/api/v2/kontokorrents`,{headers:await this.getAuthHeader()});if(!e.ok)throw new r;return await e.json()}async neuerKontokorrent(t){let n=await e(`${c}/api/v2/kontokorrents`,t,await this.getAccessToken());return 422==n.status?{success:!1,exists:!0}:n.ok?{success:!0}:{success:!1}}async getAktionen(e,t){let n=t?`?ab=${t}`:"",a=await fetch(`${c}/api/v2/kontokorrents/${e}/aktionen${n}`,{headers:await this.getAuthHeader()});if(404==a.status)return{success:!1,notfound:!0};if(a.ok){let e=await a.json();return{success:!0,aktionen:this.mapAktionen(e)}}}mapAktionen(e){for(let t of e)t.bezahlung&&(t.bezahlung.zeitpunkt=new Date(t.bezahlung.zeitpunkt));return e}async neueBezahlung(e,t){let n={method:"POST",headers:{Accept:"application/json","Content-Type":"application/vnd+kontokorrent.hinzufuegenaktion+json",Authorization:`Bearer ${await this.getAccessToken()}`},body:JSON.stringify(t)},a=await fetch(`${c}/api/v2/kontokorrents/${e}/aktionen`,n);if(a.ok){let e=await a.json();return this.mapAktionen([e])[0]}throw new i}async getAccessToken(){let r=await this.accountInfoStore.get();if(null==r)throw new Error("Keine Account Information gespeichert.");if(r.type==t.anonym){let t,a=await this.accountInfoStore.getAccessToken("anonymous");if(null!=a){let{token:e,expires:t}=JSON.parse(a.value);if(e&&t&&t>=+new Date)return e}try{let a=await e(`${c}/api/v2/token`,{id:r.id,secret:r.secret});if(!a.ok)throw new n(!1);t=await a.json()}catch(e){throw new n(!0)}return await this.accountInfoStore.updateAccessTokenIfNewer("anonymous",JSON.stringify(t),null==a?void 0:a.timestamp),t.token}throw r.type==t.google?new a:new Error(`Account Typ ${r.type} unbekannt`)}}class l{constructor(e){this.db=e}async set(e){await this.db.setAccountInfo(e)}async get(){return await this.db.getAccountInfo()}async clear(){await this.db.clearAccountInfo()}async getAccessToken(e){return await this.db.getAccessToken(e)}async updateAccessTokenIfNewer(e,t,n){return await this.db.updateAccessTokenIfNewer(e,t,n)}}let d,h;const w=new WeakMap,f=new WeakMap,g=new WeakMap,k=new WeakMap,p=new WeakMap;let y={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return f.get(e);if("objectStoreNames"===t)return e.objectStoreNames||g.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return m(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function I(e){return"function"==typeof e?(t=e)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(h||(h=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(z(this),e),m(w.get(this))}:function(...e){return m(t.apply(z(this),e))}:function(e,...n){const a=t.call(z(this),e,...n);return g.set(a,e.sort?e.sort():[e]),m(a)}:(e instanceof IDBTransaction&&function(e){if(f.has(e))return;const t=new Promise(((t,n)=>{const a=()=>{e.removeEventListener("complete",r),e.removeEventListener("error",o),e.removeEventListener("abort",o)},r=()=>{t(),a()},o=()=>{n(e.error||new DOMException("AbortError","AbortError")),a()};e.addEventListener("complete",r),e.addEventListener("error",o),e.addEventListener("abort",o)}));f.set(e,t)}(e),n=e,(d||(d=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>n instanceof e))?new Proxy(e,y):e);var t,n}function m(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const a=()=>{e.removeEventListener("success",r),e.removeEventListener("error",o)},r=()=>{t(m(e.result)),a()},o=()=>{n(e.error),a()};e.addEventListener("success",r),e.addEventListener("error",o)}));return t.then((t=>{t instanceof IDBCursor&&w.set(t,e)})).catch((()=>{})),p.set(t,e),t}(e);if(k.has(e))return k.get(e);const t=I(e);return t!==e&&(k.set(e,t),p.set(t,e)),t}const z=e=>p.get(e),b=["get","getKey","getAll","getAllKeys","count"],A=["put","add","delete","clear"],v=new Map;function B(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(v.get(t))return v.get(t);const n=t.replace(/FromIndex$/,""),a=t!==n,r=A.includes(n);if(!(n in(a?IDBIndex:IDBObjectStore).prototype)||!r&&!b.includes(n))return;const o=async function(e,...t){const o=this.transaction(e,r?"readwrite":"readonly");let s=o.store;a&&(s=s.index(t.shift()));const i=await s[n](...t);return r&&await o.done,i};return v.set(t,o),o}var S;S=y,y={...S,get:(e,t,n)=>B(e,t)||S.get(e,t,n),has:(e,t)=>!!B(e,t)||S.has(e,t)};const j="KontokorrentsStore",E="AppStateStore",N="AktionenStore",T="NeueBezahlungenStore";class D{async withInitialized(e){let t=await function(e,t,{blocked:n,upgrade:a,blocking:r,terminated:o}={}){const s=indexedDB.open(e,t),i=m(s);return a&&s.addEventListener("upgradeneeded",(e=>{a(m(s.result),e.oldVersion,e.newVersion,m(s.transaction))})),n&&s.addEventListener("blocked",(()=>n())),i.then((e=>{o&&e.addEventListener("close",(()=>o())),r&&e.addEventListener("versionchange",(()=>r()))})).catch((()=>{})),i}("kontokorrent-db",5,{upgrade(e,t,n){t<1&&e.createObjectStore(j,{keyPath:"id"}).createIndex("oeffentlicherName","oeffentlicherName"),t<2&&e.createObjectStore(E,{keyPath:"id"}).put({id:0,zuletztGesehenerKontokorrentId:null,accesstokens:[],accountinfo:null}),t<3&&e.createObjectStore(N,{keyPath:["laufendeNummer","kontokorrentId"]}).createIndex("kontokorrentId","kontokorrentId"),t<5&&(e.objectStoreNames.contains(T)&&e.deleteObjectStore(T),e.createObjectStore(T,{keyPath:"id"}).createIndex("kontokorrentId","kontokorrentId"))}});try{return await e(t)}finally{t.close()}}async getKontokorrents(){return await this.withInitialized((async e=>{return t=await e.getAll(j),n=e=>e.name,t.sort(((e,t)=>n(e).toLowerCase().localeCompare(n(t).toLowerCase())));var t,n}))}async addAktionen(e,t){if(t.length)return await this.withInitialized((async n=>{const a=n.transaction(N,"readwrite");let r=await a.store.index("kontokorrentId").getAll(e),o=t.filter((e=>!r.some((t=>e.laufendeNummer==t.laufendeNummer)))).map((t=>Object.assign(Object.assign({},t),{kontokorrentId:e})));for(let e of o)await a.store.add(e);await a.done}))}async getZuletztGesehenerKontokorrentId(){return await this.withInitialized((async e=>{let t=await e.get(E,0);if(t.zuletztGesehenerKontokorrentId)return t.zuletztGesehenerKontokorrentId;{let e=await await this.getKontokorrents();return e.length?e[0].id:null}}))}async setZuletztGesehenerKontokorrentId(e){return await this.withInitialized((async t=>{let n=await t.get(E,0);n.zuletztGesehenerKontokorrentId=e,await t.put(E,n)}))}async setKontokorrents(e){return await this.withInitialized((async t=>{let n=await t.getAll(j);for(let a of n.filter((t=>!e.some((e=>t.id===e.id)))))await t.delete(j,a.id);let a=[];for(let r of e){let e=n.find((e=>e.id==r.id));e||a.push(r.id);let o=Object.assign(Object.assign({},e),{name:r.name,personen:r.personen,id:r.id,oeffentlicherName:r.oeffentlicherName});await t.put(j,o)}return a}))}async addKontokorrent(e){return await this.withInitialized((async t=>{await t.get(j,e.id)||await t.add(j,e)}))}async getKontokorrent(e){return await this.withInitialized((async t=>await t.get(j,e)))}async getPerOeffentlichName(e){return await this.withInitialized((async t=>await t.getFromIndex(j,"oeffentlicherName",e)))}async getAktionen(e){return await this.withInitialized((async t=>await t.getAllFromIndex(N,"kontokorrentId",e)))}async clear(){return await this.withInitialized((async e=>{await e.clear(N),await e.clear(j),await e.put(E,{id:0,zuletztGesehenerKontokorrentId:null,accesstokens:[],accountinfo:null})}))}async getAccessToken(e){return await this.withInitialized((async t=>((await t.get(E,0)).accesstokens||[]).find((t=>t.type===e))))}async updateAccessTokenIfNewer(e,t,n){return await this.withInitialized((async a=>{const r=a.transaction(E,"readwrite",{durability:"strict"});let o=await r.store.get(0);o.accesstokens||(o.accesstokens=[]);let s=o.accesstokens.find((t=>t.type===e));if(s){if(s.timestamp!=n)return console.error(`The accesstoken of type ${e} was already updated since reading.`),await r.done,!1;s.value=t,s.timestamp++}else o.accesstokens.push({timestamp:1,type:e,value:t});return await r.store.put(o),await r.done,!0}))}async setAccountInfo(e){return await this.withInitialized((async t=>{const n=t.transaction(E,"readwrite");let a=await n.store.get(0);a.accountinfo=e,await n.store.put(a),await n.done}))}async getAccountInfo(){return await this.withInitialized((async e=>{const t=e.transaction(E,"readonly");let n=await t.store.get(0);return null==n?void 0:n.accountinfo}))}async clearAccountInfo(){return await this.withInitialized((async e=>{const t=e.transaction(E,"readwrite");let n=await t.store.get(0);n.accountinfo=null,n.accesstokens=[],await t.store.put(n),await t.done}))}async getZwischengespeicherteBezahlungen(){return await this.withInitialized((async e=>e.getAll(T)))}async getZwischengespeicherteBezahlungenForKontokorrent(e){return await this.withInitialized((async t=>await t.getAllFromIndex(T,"kontokorrentId",e)))}async bezahlungZwischenspeichern(e){return await this.withInitialized((async t=>{t.add(T,e)}))}async zwischengespeicherteBezahlungErledigt(e){await this.withInitialized((async t=>{t.delete(T,e)}))}}class O{constructor(e,t){this.apiClient=e,this.db=t}async bezahlungAnlegen(e,t){let n=await this.apiClient.neueBezahlung(e,t);return this.db.addAktionen(e,[n]),n}}class ${constructor(e,t){this.kontokorrentId=e,this.bezahlungId=t,this.type=25}}class L{constructor(e,t){this.kontokorrentId=e,this.bezahlungId=t,this.type=26}}const K="v8";async function x(e){const t=await self.clients.matchAll();for(const n of t)n.postMessage({type:"statedispatch",msg:e})}self.addEventListener("install",(function(e){const t=["https://fonts.googleapis.com/icon?family=Material+Icons","https://fonts.googleapis.com/css?family=Roboto:300,400,500&display=swap"];for(let e of [{'revision':null,'url':'/v2/11c8b5786f66ab427e3c.bundle.js'},{'revision':null,'url':'/v2/259.cbdb2e7b4f859e70a8da.css'},{'revision':null,'url':'/v2/25d57135123a4cf7e8cf.bundle.js'},{'revision':null,'url':'/v2/331.40854c29a162d3f529ea.css'},{'revision':null,'url':'/v2/39b40067ec9688fa767d.bundle.js'},{'revision':null,'url':'/v2/56b9992e677e8aea8600.bundle.js'},{'revision':null,'url':'/v2/634.87c330b7f696617da452.css'},{'revision':null,'url':'/v2/6c221b1e04349286a495.bundle.js'},{'revision':null,'url':'/v2/84249958d19040f9ee4f.bundle.js'},{'revision':null,'url':'/v2/ec39393d0c5a9d62476b.bundle.js'},{'revision':'3a57114c3ee13bc721c2d0415b49cc6a','url':'/v2/favicons/android-chrome-192x192.png'},{'revision':'ed824703c3c9876c64c2431f643a9874','url':'/v2/favicons/android-chrome-512x512.png'},{'revision':'c6d41b85647148e1957cef99b4906ea9','url':'/v2/favicons/apple-touch-icon.png'},{'revision':'dd5464d9de3e53bfb4dd122f57acba9e','url':'/v2/favicons/browserconfig.xml'},{'revision':'ac90a4af152a3faa919137053a51ef59','url':'/v2/favicons/favicon-16x16.png'},{'revision':'d215721a665ba9d25238477b9022f4a2','url':'/v2/favicons/favicon-32x32.png'},{'revision':'ecf16b928d22f9f9904b6fe5098f9818','url':'/v2/favicons/favicon.ico'},{'revision':'b95dc058d8d8aab47821b20aa12efc87','url':'/v2/favicons/mstile-144x144.png'},{'revision':'7b4269725276411f8f2317464308e535','url':'/v2/favicons/mstile-150x150.png'},{'revision':'bcd915cfb20f6dc9a1d9e6ec57f771bf','url':'/v2/favicons/mstile-310x150.png'},{'revision':'a6282f67b088fec98fdb90a08e9b8c11','url':'/v2/favicons/mstile-310x310.png'},{'revision':'a551b4b2f361416feaa1dfdc67ba18be','url':'/v2/favicons/mstile-70x70.png'},{'revision':'82aeb37c560455a1565fbf71310aa90b','url':'/v2/favicons/safari-pinned-tab.svg'},{'revision':null,'url':'/v2/index.5684f76bc7b88437a837.css'},{'revision':'09afe9506d36f06b33c71c8470aeaf29','url':'/v2/licenses.txt'},{'revision':'5c887ce87efbde41b424f7bea08267c3','url':'/v2/site.webmanifest'}].map((e=>e.url)))t.push(e);e.waitUntil(caches.open(K).then((function(e){return e.addAll(t)})))})),self.addEventListener("activate",(e=>{e.waitUntil(caches.keys().then((function(e){return Promise.all(e.map((function(e){if(e!==K)return caches.delete(e)})))})))})),self.addEventListener("fetch",(function(e){if("navigate"!==e.request.mode)e.respondWith(caches.match(e.request).then((function(t){return t||fetch(e.request)})));else{if("GET"!==e.request.method)return;e.respondWith(caches.match("index.html",{cacheName:K}).then((t=>t||fetch(e.request))))}}));class C{constructor(e,t){this.db=e,this.neueBezahlungenService=t}async zwischengespeicherteZahlungenAnlegen(){let e=await this.db.getZwischengespeicherteBezahlungen();for(let t of e){await x(new $(t.kontokorrentId,t.id));try{let e=await this.neueBezahlungenService.bezahlungAnlegen(t.kontokorrentId,t);await this.db.zwischengespeicherteBezahlungErledigt(e.bezahlung.id),await x(new L(t.kontokorrentId,t.id))}catch(e){console.error("Fehler beim Anlegen der Zahlung",e)}}}}self.addEventListener("sync",(function(e){"NeueBezahlungBackgroundSync"==e.tag&&e.waitUntil((async()=>{let e=new D,t=new l(e),n=new u(t),a=new O(n,e),r=new C(e,a);await r.zwischengespeicherteZahlungenAnlegen()})())}))})();
//# sourceMappingURL=sw.js.map