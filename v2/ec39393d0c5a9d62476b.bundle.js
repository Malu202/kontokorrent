(()=>{"use strict";const e=Symbol("Comlink.proxy"),t=Symbol("Comlink.endpoint"),n=Symbol("Comlink.releaseProxy"),a=Symbol("Comlink.thrown"),r=e=>"object"==typeof e&&null!==e||"function"==typeof e,o=new Map([["proxy",{canHandle:t=>r(t)&&t[e],serialize(e){const{port1:t,port2:n}=new MessageChannel;return i(e,t),[n,[n]]},deserialize:e=>(e.start(),l(e,[],undefined))}],["throw",{canHandle:e=>r(e)&&a in e,serialize({value:e}){let t;return t=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[t,[]]},deserialize(e){if(e.isError)throw Object.assign(new Error(e.value.message),e.value);throw e.value}}]]);function i(t,n=self){n.addEventListener("message",(function r(o){if(!o||!o.data)return;const{id:c,type:l,path:u}=Object.assign({path:[]},o.data),w=(o.data.argumentList||[]).map(f);let p;try{const n=u.slice(0,-1).reduce(((e,t)=>e[t]),t),a=u.reduce(((e,t)=>e[t]),t);switch(l){case 0:p=a;break;case 1:n[u.slice(-1)[0]]=f(o.data.value),p=!0;break;case 2:p=a.apply(n,w);break;case 3:p=function(t){return Object.assign(t,{[e]:!0})}(new a(...w));break;case 4:{const{port1:e,port2:n}=new MessageChannel;i(t,n),p=function(e,t){return d.set(e,t),e}(e,[e])}break;case 5:p=void 0}}catch(e){p={value:e,[a]:0}}Promise.resolve(p).catch((e=>({value:e,[a]:0}))).then((e=>{const[t,a]=h(e);n.postMessage(Object.assign(Object.assign({},t),{id:c}),a),5===l&&(n.removeEventListener("message",r),s(n))}))})),n.start&&n.start()}function s(e){(function(e){return"MessagePort"===e.constructor.name})(e)&&e.close()}function c(e){if(e)throw new Error("Proxy has been released and is not useable")}function l(e,a=[],r=function(){}){let o=!1;const i=new Proxy(r,{get(t,r){if(c(o),r===n)return()=>w(e,{type:5,path:a.map((e=>e.toString()))}).then((()=>{s(e),o=!0}));if("then"===r){if(0===a.length)return{then:()=>i};const t=w(e,{type:0,path:a.map((e=>e.toString()))}).then(f);return t.then.bind(t)}return l(e,[...a,r])},set(t,n,r){c(o);const[i,s]=h(r);return w(e,{type:1,path:[...a,n].map((e=>e.toString())),value:i},s).then(f)},apply(n,r,i){c(o);const s=a[a.length-1];if(s===t)return w(e,{type:4}).then(f);if("bind"===s)return l(e,a.slice(0,-1));const[d,h]=u(i);return w(e,{type:2,path:a.map((e=>e.toString())),argumentList:d},h).then(f)},construct(t,n){c(o);const[r,i]=u(n);return w(e,{type:3,path:a.map((e=>e.toString())),argumentList:r},i).then(f)}});return i}function u(e){const t=e.map(h);return[t.map((e=>e[0])),(n=t.map((e=>e[1])),Array.prototype.concat.apply([],n))];var n}const d=new WeakMap;function h(e){for(const[t,n]of o)if(n.canHandle(e)){const[a,r]=n.serialize(e);return[{type:3,name:t,value:a},r]}return[{type:0,value:e},d.get(e)||[]]}function f(e){switch(e.type){case 3:return o.get(e.name).deserialize(e.value);case 0:return e.value}}function w(e,t,n){return new Promise((a=>{const r=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");e.addEventListener("message",(function t(n){n.data&&n.data.id&&n.data.id===r&&(e.removeEventListener("message",t),a(n.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:r},t),n)}))}function p(e,t){const n=new Map;return e.forEach((e=>{const a=e[t],r=n.get(a);r?r.push(e):n.set(a,[e])})),n}class g{constructor(e,t,n){this.wert=e,this.empfaengerAnzahl=t,this.isEmpfaenger=n}}class m{constructor(e){this.db=e}erweitern(e,t,n){let a=1;for(let e of n)e!=t&&(a*=e);return e*a}async calculateBalance(e){let t=function(e){let t={},n=e.sort(((e,t)=>e.laufendeNummer-t.laufendeNummer));for(let e of n)e.bearbeiteteBezahlungId&&delete t[e.bearbeiteteBezahlungId],e.geloeschteBezahlungId?delete t[e.geloeschteBezahlungId]:t[e.bezahlung.id]=e.bezahlung;return Object.values(t)}(await this.db.getAktionen(e)),n=[...await this.db.getZwischengespeicherteBezahlungenForKontokorrent(e),...t],a=await this.db.getKontokorrent(e),r={};for(let e of a.personen)r[e.id]=[];for(let e of n)for(let t of e.empfaengerIds)r[t].push(new g(e.wert,e.empfaengerIds.length,!0)),r[e.bezahlendePersonId].push(new g(e.wert,e.empfaengerIds.length,!1));let o={};for(let e of a.personen){let t=p(r[e.id],"empfaengerAnzahl"),n=Array.from(t.keys()),a=Array.from(t.keys()).reduce(((e,t)=>e*t),1);if(a<362880){let r=0;for(let e of t.keys()){let a=t.get(e).reduce(((e,t)=>e+(t.isEmpfaenger?t.wert:-t.wert)),0);r+=this.erweitern(a,e,n)}o[e.id]=r/a}else{let n=0;for(let e of t.keys())n+=t.get(e).reduce(((e,t)=>e+(t.isEmpfaenger?t.wert:-t.wert)),0)/e;o[e.id]=n}}return o}}let y,k;const I=new WeakMap,b=new WeakMap,z=new WeakMap,v=new WeakMap,E=new WeakMap;let B={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return b.get(e);if("objectStoreNames"===t)return e.objectStoreNames||z.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return A(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function S(e){return"function"==typeof e?(t=e)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(k||(k=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(j(this),e),A(I.get(this))}:function(...e){return A(t.apply(j(this),e))}:function(e,...n){const a=t.call(j(this),e,...n);return z.set(a,e.sort?e.sort():[e]),A(a)}:(e instanceof IDBTransaction&&function(e){if(b.has(e))return;const t=new Promise(((t,n)=>{const a=()=>{e.removeEventListener("complete",r),e.removeEventListener("error",o),e.removeEventListener("abort",o)},r=()=>{t(),a()},o=()=>{n(e.error||new DOMException("AbortError","AbortError")),a()};e.addEventListener("complete",r),e.addEventListener("error",o),e.addEventListener("abort",o)}));b.set(e,t)}(e),n=e,(y||(y=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>n instanceof e))?new Proxy(e,B):e);var t,n}function A(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const a=()=>{e.removeEventListener("success",r),e.removeEventListener("error",o)},r=()=>{t(A(e.result)),a()},o=()=>{n(e.error),a()};e.addEventListener("success",r),e.addEventListener("error",o)}));return t.then((t=>{t instanceof IDBCursor&&I.set(t,e)})).catch((()=>{})),E.set(t,e),t}(e);if(v.has(e))return v.get(e);const t=S(e);return t!==e&&(v.set(e,t),E.set(t,e)),t}const j=e=>E.get(e),L=["get","getKey","getAll","getAllKeys","count"],N=["put","add","delete","clear"],D=new Map;function x(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(D.get(t))return D.get(t);const n=t.replace(/FromIndex$/,""),a=t!==n,r=N.includes(n);if(!(n in(a?IDBIndex:IDBObjectStore).prototype)||!r&&!L.includes(n))return;const o=async function(e,...t){const o=this.transaction(e,r?"readwrite":"readonly");let i=o.store;a&&(i=i.index(t.shift()));const s=await i[n](...t);return r&&await o.done,s};return D.set(t,o),o}var O;O=B,B={...O,get:(e,t,n)=>x(e,t)||O.get(e,t,n),has:(e,t)=>!!x(e,t)||O.has(e,t)};const K="KontokorrentsStore",M="AppStateStore",P="AktionenStore",C="NeueBezahlungenStore";class T{constructor(e){this.db=e}async getLaufendeNummer(e){let t=await this.db.getAktionen(e);return Math.max(...t.map((e=>e.laufendeNummer)))}}const G=new class{async withInitialized(e){let t=await function(e,t,{blocked:n,upgrade:a,blocking:r,terminated:o}={}){const i=indexedDB.open(e,t),s=A(i);return a&&i.addEventListener("upgradeneeded",(e=>{a(A(i.result),e.oldVersion,e.newVersion,A(i.transaction))})),n&&i.addEventListener("blocked",(()=>n())),s.then((e=>{o&&e.addEventListener("close",(()=>o())),r&&e.addEventListener("versionchange",(()=>r()))})).catch((()=>{})),s}("kontokorrent-db",5,{upgrade(e,t,n){t<1&&e.createObjectStore(K,{keyPath:"id"}).createIndex("oeffentlicherName","oeffentlicherName"),t<2&&e.createObjectStore(M,{keyPath:"id"}).put({id:0,zuletztGesehenerKontokorrentId:null,accesstokens:[],accountinfo:null}),t<3&&e.createObjectStore(P,{keyPath:["laufendeNummer","kontokorrentId"]}).createIndex("kontokorrentId","kontokorrentId"),t<5&&(e.objectStoreNames.contains(C)&&e.deleteObjectStore(C),e.createObjectStore(C,{keyPath:"id"}).createIndex("kontokorrentId","kontokorrentId"))}});try{return await e(t)}finally{t.close()}}async getKontokorrents(){return await this.withInitialized((async e=>{return t=await e.getAll(K),n=e=>e.name,t.sort(((e,t)=>n(e).toLowerCase().localeCompare(n(t).toLowerCase())));var t,n}))}async addAktionen(e,t){if(t.length)return await this.withInitialized((async n=>{const a=n.transaction(P,"readwrite");let r=await a.store.index("kontokorrentId").getAll(e),o=t.filter((e=>!r.some((t=>e.laufendeNummer==t.laufendeNummer)))).map((t=>Object.assign(Object.assign({},t),{kontokorrentId:e})));for(let e of o)await a.store.add(e);await a.done}))}async getZuletztGesehenerKontokorrentId(){return await this.withInitialized((async e=>{let t=await e.get(M,0);if(t.zuletztGesehenerKontokorrentId)return t.zuletztGesehenerKontokorrentId;{let e=await await this.getKontokorrents();return e.length?e[0].id:null}}))}async setZuletztGesehenerKontokorrentId(e){return await this.withInitialized((async t=>{let n=await t.get(M,0);n.zuletztGesehenerKontokorrentId=e,await t.put(M,n)}))}async setKontokorrents(e){return await this.withInitialized((async t=>{let n=await t.getAll(K);for(let a of n.filter((t=>!e.some((e=>t.id===e.id)))))await t.delete(K,a.id);let a=[];for(let r of e){let e=n.find((e=>e.id==r.id));e||a.push(r.id);let o=Object.assign(Object.assign({},e),{name:r.name,personen:r.personen,id:r.id,oeffentlicherName:r.oeffentlicherName});await t.put(K,o)}return a}))}async addKontokorrent(e){return await this.withInitialized((async t=>{await t.get(K,e.id)||await t.add(K,e)}))}async getKontokorrent(e){return await this.withInitialized((async t=>await t.get(K,e)))}async getPerOeffentlichName(e){return await this.withInitialized((async t=>await t.getFromIndex(K,"oeffentlicherName",e)))}async getAktionen(e){return await this.withInitialized((async t=>await t.getAllFromIndex(P,"kontokorrentId",e)))}async clear(){return await this.withInitialized((async e=>{await e.clear(P),await e.clear(K),await e.put(M,{id:0,zuletztGesehenerKontokorrentId:null,accesstokens:[],accountinfo:null})}))}async getAccessToken(e){return await this.withInitialized((async t=>((await t.get(M,0)).accesstokens||[]).find((t=>t.type===e))))}async updateAccessTokenIfNewer(e,t,n){return await this.withInitialized((async a=>{const r=a.transaction(M,"readwrite",{durability:"strict"});let o=await r.store.get(0);o.accesstokens||(o.accesstokens=[]);let i=o.accesstokens.find((t=>t.type===e));if(i){if(i.timestamp!=n)return console.error(`The accesstoken of type ${e} was already updated since reading.`),await r.done,!1;i.value=t,i.timestamp++}else o.accesstokens.push({timestamp:1,type:e,value:t});return await r.store.put(o),await r.done,!0}))}async setAccountInfo(e){return await this.withInitialized((async t=>{const n=t.transaction(M,"readwrite");let a=await n.store.get(0);a.accountinfo=e,await n.store.put(a),await n.done}))}async getAccountInfo(){return await this.withInitialized((async e=>{const t=e.transaction(M,"readonly");let n=await t.store.get(0);return null==n?void 0:n.accountinfo}))}async clearAccountInfo(){return await this.withInitialized((async e=>{const t=e.transaction(M,"readwrite");let n=await t.store.get(0);n.accountinfo=null,n.accesstokens=[],await t.store.put(n),await t.done}))}async getZwischengespeicherteBezahlungen(){return await this.withInitialized((async e=>e.getAll(C)))}async getZwischengespeicherteBezahlungenForKontokorrent(e){return await this.withInitialized((async t=>await t.getAllFromIndex(C,"kontokorrentId",e)))}async bezahlungZwischenspeichern(e){return await this.withInitialized((async t=>{t.add(C,e)}))}async zwischengespeicherteBezahlungErledigt(e){await this.withInitialized((async t=>{t.delete(C,e)}))}};i({calculateBalance:async function(e){return await new m(G).calculateBalance(e)},getLaufendeNummer:async function(e){return await new T(G).getLaufendeNummer(e)}},self)})();
//# sourceMappingURL=ec39393d0c5a9d62476b.bundle.js.map