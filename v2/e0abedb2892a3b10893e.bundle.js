(self.webpackChunkkontokorrent=self.webpackChunkkontokorrent||[]).push([[417],{417:(e,t,n)=>{"use strict";let i,o;n.d(t,{x:()=>D});const r=new WeakMap,d=new WeakMap,s=new WeakMap,c=new WeakMap,a=new WeakMap;let u={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return d.get(e);if("objectStoreNames"===t)return e.objectStoreNames||s.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return h(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function l(e){return"function"==typeof e?(t=e)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(o||(o=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(f(this),e),h(r.get(this))}:function(...e){return h(t.apply(f(this),e))}:function(e,...n){const i=t.call(f(this),e,...n);return s.set(i,e.sort?e.sort():[e]),h(i)}:(e instanceof IDBTransaction&&function(e){if(d.has(e))return;const t=new Promise(((t,n)=>{const i=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",r),e.removeEventListener("abort",r)},o=()=>{t(),i()},r=()=>{n(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",o),e.addEventListener("error",r),e.addEventListener("abort",r)}));d.set(e,t)}(e),n=e,(i||(i=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>n instanceof e))?new Proxy(e,u):e);var t,n}function h(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const i=()=>{e.removeEventListener("success",o),e.removeEventListener("error",r)},o=()=>{t(h(e.result)),i()},r=()=>{n(e.error),i()};e.addEventListener("success",o),e.addEventListener("error",r)}));return t.then((t=>{t instanceof IDBCursor&&r.set(t,e)})).catch((()=>{})),a.set(t,e),t}(e);if(c.has(e))return c.get(e);const t=l(e);return t!==e&&(c.set(e,t),a.set(t,e)),t}const f=e=>a.get(e),v=["get","getKey","getAll","getAllKeys","count"],y=["put","add","delete","clear"],k=new Map;function p(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(k.get(t))return k.get(t);const n=t.replace(/FromIndex$/,""),i=t!==n,o=y.includes(n);if(!(n in(i?IDBIndex:IDBObjectStore).prototype)||!o&&!v.includes(n))return;const r=async function(e,...t){const r=this.transaction(e,o?"readwrite":"readonly");let d=r.store;i&&(d=d.index(t.shift()));const s=await d[n](...t);return o&&await r.done,s};return k.set(t,r),r}var I;I=u,u={...I,get:(e,t,n)=>p(e,t)||I.get(e,t,n),has:(e,t)=>!!p(e,t)||I.has(e,t)};var g=n(600),w=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function d(e){try{c(i.next(e))}catch(e){r(e)}}function s(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(d,s)}c((i=i.apply(e,t||[])).next())}))};const m="KontokorrentsStore",z="AppStateStore",b="AktionenStore",B="NeueBezahlungenStore";class D{withInitialized(e){return w(this,void 0,void 0,(function*(){let t=yield function(e,t,{blocked:n,upgrade:i,blocking:o,terminated:r}={}){const d=indexedDB.open(e,t),s=h(d);return i&&d.addEventListener("upgradeneeded",(e=>{i(h(d.result),e.oldVersion,e.newVersion,h(d.transaction))})),n&&d.addEventListener("blocked",(()=>n())),s.then((e=>{r&&e.addEventListener("close",(()=>r())),o&&e.addEventListener("versionchange",(()=>o()))})).catch((()=>{})),s}("kontokorrent-db",5,{upgrade(e,t,n){t<1&&e.createObjectStore(m,{keyPath:"id"}).createIndex("oeffentlicherName","oeffentlicherName"),t<2&&e.createObjectStore(z,{keyPath:"id"}).put({id:0,zuletztGesehenerKontokorrentId:null,accesstokens:[],accountinfo:null}),t<3&&e.createObjectStore(b,{keyPath:["laufendeNummer","kontokorrentId"]}).createIndex("kontokorrentId","kontokorrentId"),t<5&&(e.objectStoreNames.contains(B)&&e.deleteObjectStore(B),e.createObjectStore(B,{keyPath:"id"}).createIndex("kontokorrentId","kontokorrentId"))}});try{return yield e(t)}finally{t.close()}}))}getKontokorrents(){return w(this,void 0,void 0,(function*(){return yield this.withInitialized((e=>w(this,void 0,void 0,(function*(){return(0,g.T)(yield e.getAll(m),(e=>e.name))}))))}))}addAktionen(e,t){return w(this,void 0,void 0,(function*(){if(t.length)return yield this.withInitialized((n=>w(this,void 0,void 0,(function*(){const i=n.transaction(b,"readwrite");let o=t.map((t=>Object.assign(Object.assign({},t),{kontokorrentId:e}))).map((e=>w(this,void 0,void 0,(function*(){try{i.store.add(e)}catch(t){console.error(`Aktion ${e.laufendeNummer} für kontokorrent ${e.kontokorrentId} war bereits hinzugefügt.`)}}))));yield Promise.all(o),yield i.done}))))}))}getZuletztGesehenerKontokorrentId(){return w(this,void 0,void 0,(function*(){return yield this.withInitialized((e=>w(this,void 0,void 0,(function*(){let t=yield e.get(z,0);if(t.zuletztGesehenerKontokorrentId)return t.zuletztGesehenerKontokorrentId;{let e=yield yield this.getKontokorrents();return e.length?e[0].id:null}}))))}))}setZuletztGesehenerKontokorrentId(e){return w(this,void 0,void 0,(function*(){return yield this.withInitialized((t=>w(this,void 0,void 0,(function*(){let n=yield t.get(z,0);n.zuletztGesehenerKontokorrentId=e,yield t.put(z,n)}))))}))}setKontokorrents(e){return w(this,void 0,void 0,(function*(){return yield this.withInitialized((t=>w(this,void 0,void 0,(function*(){let n=yield t.getAll(m);for(let i of n.filter((t=>!e.some((e=>t.id===e.id)))))yield t.delete(m,i.id);let i=[];for(let o of e){let e=n.find((e=>e.id==o.id));e||i.push(o.id);let r=Object.assign(Object.assign({},e),{name:o.name,personen:o.personen,id:o.id,oeffentlicherName:o.oeffentlicherName});yield t.put(m,r)}return i}))))}))}addKontokorrent(e){return w(this,void 0,void 0,(function*(){return yield this.withInitialized((t=>w(this,void 0,void 0,(function*(){(yield t.get(m,e.id))||(yield t.add(m,e))}))))}))}getKontokorrent(e){return w(this,void 0,void 0,(function*(){return yield this.withInitialized((t=>w(this,void 0,void 0,(function*(){return yield t.get(m,e)}))))}))}getPerOeffentlichName(e){return w(this,void 0,void 0,(function*(){return yield this.withInitialized((t=>w(this,void 0,void 0,(function*(){return yield t.getFromIndex(m,"oeffentlicherName",e)}))))}))}getAktionen(e){return w(this,void 0,void 0,(function*(){return yield this.withInitialized((t=>w(this,void 0,void 0,(function*(){return yield t.getAllFromIndex(b,"kontokorrentId",e)}))))}))}clear(){return w(this,void 0,void 0,(function*(){return yield this.withInitialized((e=>w(this,void 0,void 0,(function*(){yield e.clear(b),yield e.clear(m),yield e.put(z,{id:0,zuletztGesehenerKontokorrentId:null,accesstokens:[],accountinfo:null})}))))}))}getAccessToken(e){return w(this,void 0,void 0,(function*(){return yield this.withInitialized((t=>w(this,void 0,void 0,(function*(){return((yield t.get(z,0)).accesstokens||[]).find((t=>t.type===e))}))))}))}updateAccessTokenIfNewer(e,t,n){return w(this,void 0,void 0,(function*(){return yield this.withInitialized((i=>w(this,void 0,void 0,(function*(){const o=i.transaction(z,"readwrite",{durability:"strict"});let r=yield o.store.get(0);r.accesstokens||(r.accesstokens=[]);let d=r.accesstokens.find((t=>t.type===e));if(d){if(d.timestamp!=n)return console.error(`The accesstoken of type ${e} was already updated since reading.`),yield o.done,!1;d.value=t,d.timestamp++}else r.accesstokens.push({timestamp:1,type:e,value:t});return yield o.store.put(r),yield o.done,!0}))))}))}setAccountInfo(e){return w(this,void 0,void 0,(function*(){return yield this.withInitialized((t=>w(this,void 0,void 0,(function*(){const n=t.transaction(z,"readwrite");let i=yield n.store.get(0);i.accountinfo=e,yield n.store.put(i),yield n.done}))))}))}getAccountInfo(){return w(this,void 0,void 0,(function*(){return yield this.withInitialized((e=>w(this,void 0,void 0,(function*(){const t=e.transaction(z,"readonly");let n=yield t.store.get(0);return null==n?void 0:n.accountinfo}))))}))}clearAccountInfo(){return w(this,void 0,void 0,(function*(){return yield this.withInitialized((e=>w(this,void 0,void 0,(function*(){const t=e.transaction(z,"readwrite");let n=yield t.store.get(0);n.accountinfo=null,n.accesstokens=[],yield t.store.put(n),yield t.done}))))}))}getZwischengespeicherteBezahlungen(){return w(this,void 0,void 0,(function*(){return yield this.withInitialized((e=>w(this,void 0,void 0,(function*(){return e.getAll(B)}))))}))}getZwischengespeicherteBezahlungenForKontokorrent(e){return w(this,void 0,void 0,(function*(){return yield this.withInitialized((t=>w(this,void 0,void 0,(function*(){return yield t.getAllFromIndex(B,"kontokorrentId",e)}))))}))}bezahlungZwischenspeichern(e){return w(this,void 0,void 0,(function*(){return yield this.withInitialized((t=>w(this,void 0,void 0,(function*(){t.add(B,e)}))))}))}zwischengespeicherteBezahlungErledigt(e){return w(this,void 0,void 0,(function*(){yield this.withInitialized((t=>w(this,void 0,void 0,(function*(){t.delete(B,e)}))))}))}}},600:(e,t,n)=>{"use strict";function i(e,t){return e.sort(((e,n)=>t(e).toLowerCase().localeCompare(t(n).toLowerCase())))}n.d(t,{T:()=>i})}}]);
//# sourceMappingURL=e0abedb2892a3b10893e.bundle.js.map