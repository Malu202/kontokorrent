!function(){var e,t={8356:function(e,t,n){"use strict";const r=Symbol("Comlink.proxy"),a=Symbol("Comlink.endpoint"),i=Symbol("Comlink.releaseProxy"),o=Symbol("Comlink.thrown"),s=e=>"object"==typeof e&&null!==e||"function"==typeof e,c=new Map([["proxy",{canHandle:e=>s(e)&&e[r],serialize(e){const{port1:t,port2:n}=new MessageChannel;return l(e,t),[n,[n]]},deserialize:e=>(e.start(),d(e,[],undefined))}],["throw",{canHandle:e=>s(e)&&o in e,serialize({value:e}){let t;return t=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[t,[]]},deserialize(e){if(e.isError)throw Object.assign(new Error(e.value.message),e.value);throw e.value}}]]);function l(e,t=self){t.addEventListener("message",(function n(a){if(!a||!a.data)return;const{id:i,type:s,path:c}=Object.assign({path:[]},a.data),h=(a.data.argumentList||[]).map(p);let d;try{const t=c.slice(0,-1).reduce(((e,t)=>e[t]),e),n=c.reduce(((e,t)=>e[t]),e);switch(s){case 0:d=n;break;case 1:t[c.slice(-1)[0]]=p(a.data.value),d=!0;break;case 2:d=n.apply(t,h);break;case 3:d=function(e){return Object.assign(e,{[r]:!0})}(new n(...h));break;case 4:{const{port1:t,port2:n}=new MessageChannel;l(e,n),d=function(e,t){return g.set(e,t),e}(t,[t])}break;case 5:d=void 0}}catch(e){d={value:e,[o]:0}}Promise.resolve(d).catch((e=>({value:e,[o]:0}))).then((e=>{const[r,a]=w(e);t.postMessage(Object.assign(Object.assign({},r),{id:i}),a),5===s&&(t.removeEventListener("message",n),u(t))}))})),t.start&&t.start()}function u(e){(function(e){return"MessagePort"===e.constructor.name})(e)&&e.close()}function h(e){if(e)throw new Error("Proxy has been released and is not useable")}function d(e,t=[],n=function(){}){let r=!1;const o=new Proxy(n,{get(n,a){if(h(r),a===i)return()=>m(e,{type:5,path:t.map((e=>e.toString()))}).then((()=>{u(e),r=!0}));if("then"===a){if(0===t.length)return{then:()=>o};const n=m(e,{type:0,path:t.map((e=>e.toString()))}).then(p);return n.then.bind(n)}return d(e,[...t,a])},set(n,a,i){h(r);const[o,s]=w(i);return m(e,{type:1,path:[...t,a].map((e=>e.toString())),value:o},s).then(p)},apply(n,i,o){h(r);const s=t[t.length-1];if(s===a)return m(e,{type:4}).then(p);if("bind"===s)return d(e,t.slice(0,-1));const[c,l]=f(o);return m(e,{type:2,path:t.map((e=>e.toString())),argumentList:c},l).then(p)},construct(n,a){h(r);const[i,o]=f(a);return m(e,{type:3,path:t.map((e=>e.toString())),argumentList:i},o).then(p)}});return o}function f(e){const t=e.map(w);return[t.map((e=>e[0])),(n=t.map((e=>e[1])),Array.prototype.concat.apply([],n))];var n}const g=new WeakMap;function w(e){for(const[t,n]of c)if(n.canHandle(e)){const[r,a]=n.serialize(e);return[{type:3,name:t,value:r},a]}return[{type:0,value:e},g.get(e)||[]]}function p(e){switch(e.type){case 3:return c.get(e.name).deserialize(e.value);case 0:return e.value}}function m(e,t,n){return new Promise((r=>{const a=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");e.addEventListener("message",(function t(n){n.data&&n.data.id&&n.data.id===a&&(e.removeEventListener("message",t),r(n.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:a},t),n)}))}function y(e,t){const n=new Map;return e.forEach((e=>{const r=e[t],a=n.get(r);a?a.push(e):n.set(r,[e])})),n}class b{constructor(e,t,n){this.wert=e,this.empfaengerAnzahl=t,this.isEmpfaenger=n}}class k{constructor(e){this.db=e}erweitern(e,t,n){let r=1;for(let e of n)e!=t&&(r*=e);return e*r}async calculateBalance(e){let t=function(e){let t={},n=e.sort(((e,t)=>e.laufendeNummer-t.laufendeNummer));for(let e of n)e.bearbeiteteBezahlungId&&delete t[e.bearbeiteteBezahlungId],e.geloeschteBezahlungId?delete t[e.geloeschteBezahlungId]:t[e.bezahlung.id]=e.bezahlung;return Object.values(t)}(await this.db.getAktionen(e)),n=[...await this.db.getZwischengespeicherteBezahlungenForKontokorrent(e),...t],r=await this.db.getKontokorrent(e),a={};for(let e of r.personen)a[e.id]=[];for(let e of n)for(let t of e.empfaengerIds)a[t].push(new b(e.wert,e.empfaengerIds.length,!0)),a[e.bezahlendePersonId].push(new b(e.wert,e.empfaengerIds.length,!1));let i={};for(let e of r.personen){let t=y(a[e.id],"empfaengerAnzahl"),n=Array.from(t.keys()),r=Array.from(t.keys()).reduce(((e,t)=>e*t),1);if(r<362880){let a=0;for(let e of t.keys()){let r=t.get(e).reduce(((e,t)=>e+(t.isEmpfaenger?t.wert:-t.wert)),0);a+=this.erweitern(r,e,n)}i[e.id]=a/r}else{let n=0;for(let e of t.keys())n+=t.get(e).reduce(((e,t)=>e+(t.isEmpfaenger?t.wert:-t.wert)),0)/e;i[e.id]=n}}return i}}var z=n(9820);const I="KontokorrentsStore",v="AppStateStore",A="AktionenStore",S="NeueBezahlungenStore";class j{constructor(e){this.db=e}async getLaufendeNummer(e){let t,n=(await this.db.getAktionen(e)).map((e=>e.laufendeNummer)).sort(((e,t)=>e-t));for(t=0;t<n.length-1&&n[t]+1===n[t+1];t++);return n[t]}}n(5306);class O{constructor(e,t){this.kontokorrentId=e,this.vorschlaege=t,this.type=27}}let C={dispatch(e){self.postMessage({type:"statedispatch",msg:e})}};const x=new class{async withInitialized(e){let t=await(0,z.X3)("kontokorrent-db",5,{upgrade(e,t,n){t<1&&e.createObjectStore(I,{keyPath:"id"}).createIndex("oeffentlicherName","oeffentlicherName"),t<2&&e.createObjectStore(v,{keyPath:"id"}).put({id:0,zuletztGesehenerKontokorrentId:null,accesstokens:[],accountinfo:null}),t<3&&e.createObjectStore(A,{keyPath:["laufendeNummer","kontokorrentId"]}).createIndex("kontokorrentId","kontokorrentId"),t<5&&(e.objectStoreNames.contains(S)&&e.deleteObjectStore(S),e.createObjectStore(S,{keyPath:"id"}).createIndex("kontokorrentId","kontokorrentId"))}});try{return await e(t)}finally{t.close()}}async getKontokorrents(){return await this.withInitialized((async e=>{return t=await e.getAll(I),n=e=>e.name,t.sort(((e,t)=>n(e).toLowerCase().localeCompare(n(t).toLowerCase())));var t,n}))}async addAktionen(e,t){if(!t.length)return;let n=t.map((t=>Object.assign(Object.assign({},t),{kontokorrentId:e})));return await this.withInitialized((t=>{const r=(0,z.Wg)(t);return new Promise(((t,a)=>{const i=r.transaction(A,"readwrite");i.onerror=e=>{console.error("addAktionen failed",e,i.error),a(i.error)},i.oncomplete=()=>{t()};for(let t of n){let n=i.objectStore(A).add(t);n.onerror=r=>{"ConstraintError"==n.error.name?(console.log(`Aktion ${t.laufendeNummer} für Kontokorrent ${e} bereits gespeichert.`,r,n.error),r.preventDefault(),r.stopPropagation()):console.error(`Aktion ${t.laufendeNummer} für Kontokorrent ${e} konnte nicht gespeichert werden.`,r,n.error)}}}))}))}async getZuletztGesehenerKontokorrentId(){return await this.withInitialized((async e=>{let t=await e.get(v,0);if(t.zuletztGesehenerKontokorrentId)return t.zuletztGesehenerKontokorrentId;{let e=await await this.getKontokorrents();return e.length?e[0].id:null}}))}async setZuletztGesehenerKontokorrentId(e){return await this.withInitialized((async t=>{let n=await t.get(v,0);n.zuletztGesehenerKontokorrentId=e,await t.put(v,n)}))}async setKontokorrents(e){return await this.withInitialized((async t=>{let n=await t.getAll(I);for(let r of n.filter((t=>!e.some((e=>t.id===e.id)))))await t.delete(I,r.id);let r=[];for(let a of e){let e=n.find((e=>e.id==a.id));e||r.push(a.id);let i=Object.assign(Object.assign({},e),{name:a.name,personen:a.personen,id:a.id,oeffentlicherName:a.oeffentlicherName});await t.put(I,i)}return r}))}async addKontokorrent(e){return await this.withInitialized((async t=>{await t.get(I,e.id)||await t.add(I,e)}))}async getKontokorrent(e){return await this.withInitialized((async t=>await t.get(I,e)))}async getPerOeffentlichName(e){return await this.withInitialized((async t=>await t.getFromIndex(I,"oeffentlicherName",e)))}async getAktionen(e){return await this.withInitialized((async t=>await t.getAllFromIndex(A,"kontokorrentId",e)))}async clear(){return await this.withInitialized((async e=>{await e.clear(A),await e.clear(I),await e.put(v,{id:0,zuletztGesehenerKontokorrentId:null,accesstokens:[],accountinfo:null})}))}async getAccessToken(e){return await this.withInitialized((async t=>((await t.get(v,0)).accesstokens||[]).find((t=>t.type===e))))}async updateAccessTokenIfNewer(e,t,n){return await this.withInitialized((async r=>{const a=r.transaction(v,"readwrite",{durability:"strict"});let i=await a.store.get(0);i.accesstokens||(i.accesstokens=[]);let o=i.accesstokens.find((t=>t.type===e));if(o){if(o.timestamp!=n)return console.error(`The accesstoken of type ${e} was already updated since reading.`),await a.done,!1;o.value=t,o.timestamp++}else i.accesstokens.push({timestamp:1,type:e,value:t});return await a.store.put(i),await a.done,!0}))}async setAccountInfo(e){return await this.withInitialized((async t=>{const n=t.transaction(v,"readwrite");let r=await n.store.get(0);r.accountinfo=e,await n.store.put(r),await n.done}))}async getAccountInfo(){return await this.withInitialized((async e=>{const t=e.transaction(v,"readonly");let n=await t.store.get(0);return null==n?void 0:n.accountinfo}))}async clearAccountInfo(){return await this.withInitialized((async e=>{const t=e.transaction(v,"readwrite");let n=await t.store.get(0);n.accountinfo=null,n.accesstokens=[],await t.store.put(n),await t.done}))}async getZwischengespeicherteBezahlungen(){return await this.withInitialized((async e=>await e.getAll(S)))}async getBezahlungAktion(e,t){return await this.withInitialized((async n=>{var r=n.getAllFromIndex(A,"kontokorrentId",e);return(await r).find((e=>e.bezahlung&&e.bezahlung.id==t))}))}async getZwischengespeicherteBezahlungenForKontokorrent(e){return await this.withInitialized((async t=>await t.getAllFromIndex(S,"kontokorrentId",e)))}async bezahlungZwischenspeichern(e){return await this.withInitialized((async t=>{t.add(S,e)}))}async zwischengespeicherteBezahlungErledigt(e){await this.withInitialized((async t=>{t.delete(S,e)}))}},N=new class{constructor(e,t){this.db=e,this.store=t,this.beschreibungenCache={kontokorrentId:null,beschreibungen:[]}}formatSearchString(e){return e.toLowerCase().replace(/\s|-/g,"")}sameChars(e,t){let n;for(n=0;n<Math.min(e.length,t.length)&&e[n]==t[n];n++);return n}async getVorschlaege(e,t){if(this.beschreibungenCache.kontokorrentId!=e){let t=(await this.db.getAktionen(e)).filter((e=>{var t;return null!=(null===(t=e.bezahlung)||void 0===t?void 0:t.beschreibung)})).map((e=>({search:this.formatSearchString(e.bezahlung.beschreibung),result:e.bezahlung.beschreibung.trim()})));this.beschreibungenCache.kontokorrentId=e;let n=y(t,"search");this.beschreibungenCache.beschreibungen=Array.from(n.entries()).map((([e,t])=>({search:e,result:t[0].result,occurence:t.length}))).sort(((e,t)=>t.occurence-e.occurence))}if(t){let n=this.formatSearchString(t),r=this.beschreibungenCache.beschreibungen.filter((({search:e})=>e.indexOf(n)>-1)).map((({search:e,result:t})=>({result:t,score:this.sameChars(n,e)}))).sort(((e,t)=>t.score-e.score));this.store.dispatch(new O(e,r.map((e=>e.result))))}else{let t=this.beschreibungenCache.beschreibungen.slice(0,10).map((e=>e.result));this.store.dispatch(new O(e,t))}}}(x,C);l({calculateBalance:async function(e){return await new k(x).calculateBalance(e)},getLaufendeNummer:async function(e){return await new j(x).getLaufendeNummer(e)},getBeschreibungVorschlaege:async function(e,t){await N.getVorschlaege(e,t)}},self)},3070:function(e,t,n){var r=n(9781),a=n(4664),i=n(9670),o=n(7593),s=Object.defineProperty;t.f=r?s:function(e,t,n){if(i(e),t=o(t,!0),i(n),a)try{return s(e,t,n)}catch(e){}if("get"in n||"set"in n)throw TypeError("Accessors not supported");return"value"in n&&(e[t]=n.value),e}},8006:function(e,t,n){var r=n(6324),a=n(748).concat("length","prototype");t.f=Object.getOwnPropertyNames||function(e){return r(e,a)}}},n={};function r(e){if(n[e])return n[e].exports;var a=n[e]={exports:{}};return t[e](a,a.exports,r),a.exports}r.m=t,r.x=function(){r(8356)},r.d=function(e,t){for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.f={},r.e=function(e){return Promise.all(Object.keys(r.f).reduce((function(t,n){return r.f[n](e,t),t}),[]))},r.u=function(e){return"eaec552c6841364e2f3d.bundle.js"},r.miniCssF=function(e){return e+"."+{858:"31d6cfe0d16ae931b73c"}[e]+".css"},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},e=r.x,r.x=function(){return r.e(858).then(e)},r.p="/v2/",function(){var e={458:1};r.f.i=function(t,n){e[t]||importScripts(""+r.u(t))};var t=self.webpackChunkkontokorrent=self.webpackChunkkontokorrent||[],n=t.push.bind(t);t.push=function(t){var a=t[0],i=t[1],o=t[2];for(var s in i)r.o(i,s)&&(r.m[s]=i[s]);for(o&&o(r);a.length;)e[a.pop()]=1;n(t)}}(),r.x()}();
//# sourceMappingURL=19efd8f5ea14a29f72ec.bundle.js.map