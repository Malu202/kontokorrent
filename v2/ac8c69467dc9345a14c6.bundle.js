(()=>{"use strict";const e=Symbol("Comlink.proxy"),t=Symbol("Comlink.endpoint"),n=Symbol("Comlink.releaseProxy"),r=Symbol("Comlink.thrown"),i=e=>"object"==typeof e&&null!==e||"function"==typeof e,o=new Map([["proxy",{canHandle:t=>i(t)&&t[e],serialize(e){const{port1:t,port2:n}=new MessageChannel;return s(e,t),[n,[n]]},deserialize:e=>(e.start(),d(e,[],undefined))}],["throw",{canHandle:e=>i(e)&&r in e,serialize({value:e}){let t;return t=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[t,[]]},deserialize(e){if(e.isError)throw Object.assign(new Error(e.value.message),e.value);throw e.value}}]]);function s(t,n=self){n.addEventListener("message",(function i(o){if(!o||!o.data)return;const{id:c,type:d,path:u}=Object.assign({path:[]},o.data),p=(o.data.argumentList||[]).map(h);let v;try{const n=u.slice(0,-1).reduce(((e,t)=>e[t]),t),r=u.reduce(((e,t)=>e[t]),t);switch(d){case 0:v=r;break;case 1:n[u.slice(-1)[0]]=h(o.data.value),v=!0;break;case 2:v=r.apply(n,p);break;case 3:v=function(t){return Object.assign(t,{[e]:!0})}(new r(...p));break;case 4:{const{port1:e,port2:n}=new MessageChannel;s(t,n),v=function(e,t){return l.set(e,t),e}(e,[e])}break;case 5:v=void 0}}catch(e){v={value:e,[r]:0}}Promise.resolve(v).catch((e=>({value:e,[r]:0}))).then((e=>{const[t,r]=f(e);n.postMessage(Object.assign(Object.assign({},t),{id:c}),r),5===d&&(n.removeEventListener("message",i),a(n))}))})),n.start&&n.start()}function a(e){(function(e){return"MessagePort"===e.constructor.name})(e)&&e.close()}function c(e){if(e)throw new Error("Proxy has been released and is not useable")}function d(e,r=[],i=function(){}){let o=!1;const s=new Proxy(i,{get(t,i){if(c(o),i===n)return()=>p(e,{type:5,path:r.map((e=>e.toString()))}).then((()=>{a(e),o=!0}));if("then"===i){if(0===r.length)return{then:()=>s};const t=p(e,{type:0,path:r.map((e=>e.toString()))}).then(h);return t.then.bind(t)}return d(e,[...r,i])},set(t,n,i){c(o);const[s,a]=f(i);return p(e,{type:1,path:[...r,n].map((e=>e.toString())),value:s},a).then(h)},apply(n,i,s){c(o);const a=r[r.length-1];if(a===t)return p(e,{type:4}).then(h);if("bind"===a)return d(e,r.slice(0,-1));const[l,f]=u(s);return p(e,{type:2,path:r.map((e=>e.toString())),argumentList:l},f).then(h)},construct(t,n){c(o);const[i,s]=u(n);return p(e,{type:3,path:r.map((e=>e.toString())),argumentList:i},s).then(h)}});return s}function u(e){const t=e.map(f);return[t.map((e=>e[0])),(n=t.map((e=>e[1])),Array.prototype.concat.apply([],n))];var n}const l=new WeakMap;function f(e){for(const[t,n]of o)if(n.canHandle(e)){const[r,i]=n.serialize(e);return[{type:3,name:t,value:r},i]}return[{type:0,value:e},l.get(e)||[]]}function h(e){switch(e.type){case 3:return o.get(e.name).deserialize(e.value);case 0:return e.value}}function p(e,t,n){return new Promise((r=>{const i=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");e.addEventListener("message",(function t(n){n.data&&n.data.id&&n.data.id===i&&(e.removeEventListener("message",t),r(n.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:i},t),n)}))}function v(e,t){const n=new Map;return e.forEach((e=>{const r=e[t],i=n.get(r);i?i.push(e):n.set(r,[e])})),n}class y{constructor(e,t,n){this.wert=e,this.empfaengerAnzahl=t,this.isEmpfaenger=n}}class m{constructor(e){this.db=e}erweitern(e,t,n){let r=1;for(let e of n)e!=t&&(r*=e);return e*r}calculateBalance(e){return t=this,n=void 0,i=function*(){let t=function(e){let t={},n=e.sort(((e,t)=>e.laufendeNummer-t.laufendeNummer));for(let e of n)e.bearbeiteteBezahlungId&&delete t[e.bearbeiteteBezahlungId],e.geloeschteBezahlungId?delete t[e.geloeschteBezahlungId]:t[e.bezahlung.id]=e.bezahlung;return Object.values(t)}(yield this.db.getAktionen(e)),n=yield this.db.getKontokorrent(e),r={};for(let e of n.personen)r[e.id]=[];for(let e of t)for(let t of e.empfaengerIds)r[t].push(new y(e.wert,e.empfaengerIds.length,!0)),r[e.bezahlendePersonId].push(new y(e.wert,e.empfaengerIds.length,!1));let i={};for(let e of n.personen){let t=v(r[e.id],"empfaengerAnzahl"),n=Array.from(t.keys()),o=Array.from(t.keys()).reduce(((e,t)=>e*t),1);if(o<362880){let r=0;for(let e of t.keys()){let i=t.get(e).reduce(((e,t)=>e+(t.isEmpfaenger?t.wert:-t.wert)),0);r+=this.erweitern(i,e,n)}i[e.id]=r/o}else{let n=0;for(let e of t.keys())n+=t.get(e).reduce(((e,t)=>e+(t.isEmpfaenger?t.wert:-t.wert)),0)/e;i[e.id]=n}}return i},new((r=void 0)||(r=Promise))((function(e,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function a(e){try{c(i.throw(e))}catch(e){o(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r((function(e){e(n)}))).then(s,a)}c((i=i.apply(t,n||[])).next())}));var t,n,r,i}}let g,w;const k=new WeakMap,b=new WeakMap,I=new WeakMap,z=new WeakMap,E=new WeakMap;let B={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return b.get(e);if("objectStoreNames"===t)return e.objectStoreNames||I.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return S(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function L(e){return"function"==typeof e?(t=e)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(w||(w=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(x(this),e),S(k.get(this))}:function(...e){return S(t.apply(x(this),e))}:function(e,...n){const r=t.call(x(this),e,...n);return I.set(r,e.sort?e.sort():[e]),S(r)}:(e instanceof IDBTransaction&&function(e){if(b.has(e))return;const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",o),e.removeEventListener("abort",o)},i=()=>{t(),r()},o=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",i),e.addEventListener("error",o),e.addEventListener("abort",o)}));b.set(e,t)}(e),n=e,(g||(g=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>n instanceof e))?new Proxy(e,B):e);var t,n}function S(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("success",i),e.removeEventListener("error",o)},i=()=>{t(S(e.result)),r()},o=()=>{n(e.error),r()};e.addEventListener("success",i),e.addEventListener("error",o)}));return t.then((t=>{t instanceof IDBCursor&&k.set(t,e)})).catch((()=>{})),E.set(t,e),t}(e);if(z.has(e))return z.get(e);const t=L(e);return t!==e&&(z.set(e,t),E.set(t,e)),t}const x=e=>E.get(e),j=["get","getKey","getAll","getAllKeys","count"],A=["put","add","delete","clear"],D=new Map;function N(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(D.get(t))return D.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,i=A.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!i&&!j.includes(n))return;const o=async function(e,...t){const o=this.transaction(e,i?"readwrite":"readonly");let s=o.store;r&&(s=s.index(t.shift()));const a=await s[n](...t);return i&&await o.done,a};return D.set(t,o),o}var P;P=B,B={...P,get:(e,t,n)=>N(e,t)||P.get(e,t,n),has:(e,t)=>!!N(e,t)||P.has(e,t)};var M=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};const O="KontokorrentsStore",K="AppStateStore",C="AktionenStore";class T{constructor(e){this.db=e}getLaufendeNummer(e){return t=this,n=void 0,i=function*(){let t=yield this.db.getAktionen(e);return Math.max(...t.map((e=>e.laufendeNummer)))},new((r=void 0)||(r=Promise))((function(e,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function a(e){try{c(i.throw(e))}catch(e){o(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r((function(e){e(n)}))).then(s,a)}c((i=i.apply(t,n||[])).next())}));var t,n,r,i}}var G=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};const W=new class{withInitialized(e){return M(this,void 0,void 0,(function*(){let t=yield function(e,t,{blocked:n,upgrade:r,blocking:i,terminated:o}={}){const s=indexedDB.open(e,t),a=S(s);return r&&s.addEventListener("upgradeneeded",(e=>{r(S(s.result),e.oldVersion,e.newVersion,S(s.transaction))})),n&&s.addEventListener("blocked",(()=>n())),a.then((e=>{o&&e.addEventListener("close",(()=>o())),i&&e.addEventListener("versionchange",(()=>i()))})).catch((()=>{})),a}("kontokorrent-db",3,{upgrade(e,t,n){t<1&&e.createObjectStore(O,{keyPath:"id"}).createIndex("oeffentlicherName","oeffentlicherName"),t<2&&e.createObjectStore(K,{keyPath:"id"}).put({id:0,zuletztGesehenerKontokorrentId:null,accesstokens:[]}),t<3&&e.createObjectStore(C,{keyPath:["laufendeNummer","kontokorrentId"]}).createIndex("kontokorrentId","kontokorrentId")}});try{return yield e(t)}finally{t.close()}}))}getKontokorrents(){return M(this,void 0,void 0,(function*(){return yield this.withInitialized((e=>M(this,void 0,void 0,(function*(){return t=yield e.getAll(O),n=e=>e.name,t.sort(((e,t)=>n(e).toLowerCase().localeCompare(n(t).toLowerCase())));var t,n}))))}))}addAktionen(e,t){return M(this,void 0,void 0,(function*(){if(t.length)return yield this.withInitialized((n=>M(this,void 0,void 0,(function*(){const r=n.transaction(C,"readwrite");let i=t.map((t=>Object.assign(Object.assign({},t),{kontokorrentId:e}))).map((e=>r.store.add(e)));yield Promise.all(i),yield r.done}))))}))}getZuletztGesehenerKontokorrentId(){return M(this,void 0,void 0,(function*(){return yield this.withInitialized((e=>M(this,void 0,void 0,(function*(){let t=yield e.get(K,0);if(t.zuletztGesehenerKontokorrentId)return t.zuletztGesehenerKontokorrentId;{let e=yield yield this.getKontokorrents();return e.length?e[0].id:null}}))))}))}setZuletztGesehenerKontokorrentId(e){return M(this,void 0,void 0,(function*(){return yield this.withInitialized((t=>M(this,void 0,void 0,(function*(){let n=yield t.get(K,0);n.zuletztGesehenerKontokorrentId=e,yield t.put(K,n)}))))}))}setKontokorrents(e){return M(this,void 0,void 0,(function*(){return yield this.withInitialized((t=>M(this,void 0,void 0,(function*(){let n=yield t.getAll(O);for(let r of n.filter((t=>!e.some((e=>t.id===e.id)))))yield t.delete(O,r.id);let r=[];for(let i of e){let e=n.find((e=>e.id==i.id));e||r.push(i.id);let o=Object.assign(Object.assign({},e),{name:i.name,personen:i.personen,id:i.id,oeffentlicherName:i.oeffentlicherName});yield t.put(O,o)}return r}))))}))}addKontokorrent(e){return M(this,void 0,void 0,(function*(){return yield this.withInitialized((t=>M(this,void 0,void 0,(function*(){(yield t.get(O,e.id))||(yield t.add(O,e))}))))}))}getKontokorrent(e){return M(this,void 0,void 0,(function*(){return yield this.withInitialized((t=>M(this,void 0,void 0,(function*(){return yield t.get(O,e)}))))}))}getPerOeffentlichName(e){return M(this,void 0,void 0,(function*(){return yield this.withInitialized((t=>M(this,void 0,void 0,(function*(){return yield t.getFromIndex(O,"oeffentlicherName",e)}))))}))}getAktionen(e){return M(this,void 0,void 0,(function*(){return yield this.withInitialized((t=>M(this,void 0,void 0,(function*(){return yield t.getAllFromIndex(C,"kontokorrentId",e)}))))}))}clear(){return M(this,void 0,void 0,(function*(){return yield this.withInitialized((e=>M(this,void 0,void 0,(function*(){yield e.clear(C),yield e.clear(O),yield e.put(K,{id:0,zuletztGesehenerKontokorrentId:null,accesstokens:[]})}))))}))}getAccessToken(e){return M(this,void 0,void 0,(function*(){return yield this.withInitialized((t=>M(this,void 0,void 0,(function*(){return((yield t.get(K,0)).accesstokens||[]).find((t=>t.type===e))}))))}))}updateAccessTokenIfNewer(e,t,n){return M(this,void 0,void 0,(function*(){return yield this.withInitialized((r=>M(this,void 0,void 0,(function*(){const i=r.transaction(K,"readwrite",{durability:"strict"});let o=yield i.store.get(0);o.accesstokens||(o.accesstokens=[]);let s=o.accesstokens.find((t=>t.type===e));if(s){if(s.timestamp!=n)return console.error(`The accesstoken of type ${e} was already updated since reading.`),yield i.done,!1;s.value=t,s.timestamp++}else o.accesstokens.push({timestamp:1,type:e,value:t});return yield i.store.put(o),yield i.done,!0}))))}))}};s({calculateBalance:function(e){return G(this,void 0,void 0,(function*(){return yield new m(W).calculateBalance(e)}))},getLaufendeNummer:function(e){return G(this,void 0,void 0,(function*(){return yield new T(W).getLaufendeNummer(e)}))}},self)})();
//# sourceMappingURL=ac8c69467dc9345a14c6.bundle.js.map